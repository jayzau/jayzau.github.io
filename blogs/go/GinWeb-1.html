<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Gin Web Framework | Jayzau</title>
    <meta name="generator" content="VuePress 1.7.1">
    
    <meta name="description" content="好劲!">
    
    <link rel="preload" href="/assets/css/0.styles.c0542458.css" as="style"><link rel="preload" href="/assets/js/app.c5305ee3.js" as="script"><link rel="preload" href="/assets/js/2.2733607c.js" as="script"><link rel="preload" href="/assets/js/8.4f988748.js" as="script"><link rel="prefetch" href="/assets/js/10.ef8e919d.js"><link rel="prefetch" href="/assets/js/11.8ec9eea4.js"><link rel="prefetch" href="/assets/js/12.d902eacd.js"><link rel="prefetch" href="/assets/js/13.aec05fab.js"><link rel="prefetch" href="/assets/js/14.2805f5ea.js"><link rel="prefetch" href="/assets/js/15.8a264712.js"><link rel="prefetch" href="/assets/js/16.3b4138e0.js"><link rel="prefetch" href="/assets/js/17.eec3c406.js"><link rel="prefetch" href="/assets/js/18.25d28f03.js"><link rel="prefetch" href="/assets/js/19.090949aa.js"><link rel="prefetch" href="/assets/js/20.43c0a74c.js"><link rel="prefetch" href="/assets/js/21.f60ea17e.js"><link rel="prefetch" href="/assets/js/22.022efc2e.js"><link rel="prefetch" href="/assets/js/23.a3cee758.js"><link rel="prefetch" href="/assets/js/24.dfaf9b90.js"><link rel="prefetch" href="/assets/js/25.4bb80798.js"><link rel="prefetch" href="/assets/js/26.7dc791f1.js"><link rel="prefetch" href="/assets/js/27.b87628ec.js"><link rel="prefetch" href="/assets/js/28.b44871cc.js"><link rel="prefetch" href="/assets/js/29.ac371324.js"><link rel="prefetch" href="/assets/js/3.2241a300.js"><link rel="prefetch" href="/assets/js/30.c10170f6.js"><link rel="prefetch" href="/assets/js/31.ab3d6217.js"><link rel="prefetch" href="/assets/js/32.1e3fbc5c.js"><link rel="prefetch" href="/assets/js/33.13439f83.js"><link rel="prefetch" href="/assets/js/34.ee9bff09.js"><link rel="prefetch" href="/assets/js/35.b9fbcc7f.js"><link rel="prefetch" href="/assets/js/36.9293bf0b.js"><link rel="prefetch" href="/assets/js/37.71f16844.js"><link rel="prefetch" href="/assets/js/38.2c1388e6.js"><link rel="prefetch" href="/assets/js/4.5a3a6bf8.js"><link rel="prefetch" href="/assets/js/5.aad4954c.js"><link rel="prefetch" href="/assets/js/6.20be021d.js"><link rel="prefetch" href="/assets/js/7.5a1615ac.js"><link rel="prefetch" href="/assets/js/9.e5f1a567.js">
    <link rel="stylesheet" href="/assets/css/0.styles.c0542458.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">Jayzau</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">
  首页
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="博客" class="dropdown-title"><span class="title">博客</span> <span class="arrow down"></span></button> <button type="button" aria-label="博客" class="mobile-dropdown-title"><span class="title">博客</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/blogs/notes/" class="nav-link">
  笔记
</a></li><li class="dropdown-item"><!----> <a href="/blogs/python/" class="nav-link">
  Python
</a></li><li class="dropdown-item"><!----> <a href="/blogs/javascript/" class="nav-link">
  JavaScript
</a></li><li class="dropdown-item"><!----> <a href="/blogs/php/" class="nav-link">
  PHP
</a></li><li class="dropdown-item"><!----> <a href="/blogs/go/" class="nav-link router-link-active">
  Go
</a></li></ul></div></div><div class="nav-item"><a href="https://github.com/jayzau" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">
  首页
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="博客" class="dropdown-title"><span class="title">博客</span> <span class="arrow down"></span></button> <button type="button" aria-label="博客" class="mobile-dropdown-title"><span class="title">博客</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/blogs/notes/" class="nav-link">
  笔记
</a></li><li class="dropdown-item"><!----> <a href="/blogs/python/" class="nav-link">
  Python
</a></li><li class="dropdown-item"><!----> <a href="/blogs/javascript/" class="nav-link">
  JavaScript
</a></li><li class="dropdown-item"><!----> <a href="/blogs/php/" class="nav-link">
  PHP
</a></li><li class="dropdown-item"><!----> <a href="/blogs/go/" class="nav-link router-link-active">
  Go
</a></li></ul></div></div><div class="nav-item"><a href="https://github.com/jayzau" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>Gin Web Framework</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/blogs/go/GinWeb-1.html#安装" class="sidebar-link">安装</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blogs/go/GinWeb-1.html#运行环境测试" class="sidebar-link">运行环境测试</a></li></ul></li><li><a href="/blogs/go/GinWeb-1.html#基础" class="sidebar-link">基础</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blogs/go/GinWeb-1.html#模板使用" class="sidebar-link">模板使用</a></li><li class="sidebar-sub-header"><a href="/blogs/go/GinWeb-1.html#jsonp" class="sidebar-link">JSONP</a></li><li class="sidebar-sub-header"><a href="/blogs/go/GinWeb-1.html#purejson" class="sidebar-link">PureJSON</a></li><li class="sidebar-sub-header"><a href="/blogs/go/GinWeb-1.html#securejson" class="sidebar-link">？SecureJSON</a></li><li class="sidebar-sub-header"><a href="/blogs/go/GinWeb-1.html#表单和查询参数" class="sidebar-link">表单和查询参数</a></li><li class="sidebar-sub-header"><a href="/blogs/go/GinWeb-1.html#将request-body绑定到不同的结构体" class="sidebar-link">？将request body绑定到不同的结构体</a></li><li class="sidebar-sub-header"><a href="/blogs/go/GinWeb-1.html#文件上传" class="sidebar-link">文件上传</a></li><li class="sidebar-sub-header"><a href="/blogs/go/GinWeb-1.html#从-reader-读取数据-文件下载" class="sidebar-link">从 reader 读取数据（文件下载）</a></li><li class="sidebar-sub-header"><a href="/blogs/go/GinWeb-1.html#优雅地重启或停止" class="sidebar-link">优雅地重启或停止</a></li><li class="sidebar-sub-header"><a href="/blogs/go/GinWeb-1.html#basicauth-中间件" class="sidebar-link">BasicAuth 中间件</a></li><li class="sidebar-sub-header"><a href="/blogs/go/GinWeb-1.html#中间件" class="sidebar-link">中间件</a></li><li class="sidebar-sub-header"><a href="/blogs/go/GinWeb-1.html#中间件中使用-goroutine" class="sidebar-link">中间件中使用 Goroutine</a></li><li class="sidebar-sub-header"><a href="/blogs/go/GinWeb-1.html#日志记录" class="sidebar-link">日志记录</a></li><li class="sidebar-sub-header"><a href="/blogs/go/GinWeb-1.html#映射查询字符串或表单参数" class="sidebar-link">映射查询字符串或表单参数</a></li><li class="sidebar-sub-header"><a href="/blogs/go/GinWeb-1.html#自定义-http-配置" class="sidebar-link">自定义 HTTP 配置</a></li><li class="sidebar-sub-header"><a href="/blogs/go/GinWeb-1.html#cookie" class="sidebar-link">Cookie</a></li><li class="sidebar-sub-header"><a href="/blogs/go/GinWeb-1.html#路由参数" class="sidebar-link">路由参数</a></li><li class="sidebar-sub-header"><a href="/blogs/go/GinWeb-1.html#重定向" class="sidebar-link">重定向</a></li><li class="sidebar-sub-header"><a href="/blogs/go/GinWeb-1.html#静态文件服务" class="sidebar-link">静态文件服务</a></li></ul></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="gin-web-framework"><a href="#gin-web-framework" class="header-anchor">#</a> Gin Web Framework</h1> <p><a href="https://gin-gonic.com/zh-cn/docs/quickstart/" target="_blank" rel="noopener noreferrer">快速入门<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <h2 id="安装"><a href="#安装" class="header-anchor">#</a> 安装</h2> <p><code>go get -u github.com/gin-gonic/gin</code></p> <div class="language-shell extra-class"><pre class="language-shell"><code>gnutls_handshake<span class="token punctuation">(</span><span class="token punctuation">)</span> failed: The TLS connection was non-properly terminated.
<span class="token punctuation">..</span>.
</code></pre></div><p>安装受挫...</p> <p><a href="https://goproxy.io/zh/" target="_blank" rel="noopener noreferrer">上代理<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token builtin class-name">export</span> <span class="token assign-left variable">GOPROXY</span><span class="token operator">=</span>https://goproxy.io,direct
</code></pre></div><p>再次受挫...</p> <p>手动克隆代码至对应目录：</p> <table><thead><tr><th>报错</th> <th>克隆目录</th> <th>仓库链接</th></tr></thead> <tbody><tr><td>cannot find package &quot;golang.org/x/crypto/*?&quot;</td> <td><code>$GOPATH/src/golang.org/x/crypto</code></td> <td><a href="https://github.com/golang/crypto" target="_blank" rel="noopener noreferrer">crypto<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></td></tr> <tr><td>cannot find package &quot;golang.org/x/sys/*?&quot;</td> <td><code>$GOPATH/src/golang.org/x/sys</code></td> <td><a href="https://github.com/golang/sys" target="_blank" rel="noopener noreferrer">sys<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></td></tr> <tr><td>cannot find package &quot;google.golang.org/protobuf/*?&quot;</td> <td><code>$GOPATH/src/google.golang.org/protobuf</code></td> <td><a href="https://github.com/protocolbuffers/protobuf-go" target="_blank" rel="noopener noreferrer">protobuf-go<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></td></tr></tbody></table> <p>!<code>protobuf-go</code>需注意文件名：<code>mv protobuf-go/ protobuf/</code></p> <h3 id="运行环境测试"><a href="#运行环境测试" class="header-anchor">#</a> 运行环境测试</h3> <div class="language-go extra-class"><pre class="language-go"><code><span class="token comment">// $GOPATH/src/main.go</span>
<span class="token keyword">package</span> main

<span class="token keyword">import</span> <span class="token string">&quot;github.com/gin-gonic/gin&quot;</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	r <span class="token operator">:=</span> gin<span class="token punctuation">.</span><span class="token function">Default</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token comment">// gin.H 是 map[string]interface{} 的一种快捷方式</span>
    <span class="token comment">// type H map[string]interface{}</span>
	r<span class="token punctuation">.</span><span class="token function">GET</span><span class="token punctuation">(</span><span class="token string">&quot;/ping&quot;</span><span class="token punctuation">,</span> <span class="token keyword">func</span><span class="token punctuation">(</span>c <span class="token operator">*</span>gin<span class="token punctuation">.</span>Context<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		c<span class="token punctuation">.</span><span class="token function">JSON</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">,</span> gin<span class="token punctuation">.</span>H<span class="token punctuation">{</span>
			<span class="token string">&quot;message&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;pong&quot;</span><span class="token punctuation">,</span>
		<span class="token punctuation">}</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span><span class="token punctuation">)</span>
	r<span class="token punctuation">.</span><span class="token function">Run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// listen and serve on 0.0.0.0:8080 (for windows &quot;localhost:8080&quot;)</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="基础"><a href="#基础" class="header-anchor">#</a> 基础</h2> <h3 id="模板使用"><a href="#模板使用" class="header-anchor">#</a> 模板使用</h3> <p>Goland 模板高亮提示设置：</p> <p><img src="/images/go/GinWeb-1/template.jpg" alt="设置"></p> <p>模板的渲染：使用<code>LoadHTMLGlob</code>或<code>LoadHTMLFiles</code>。</p> <p>目录结构如下：</p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token builtin class-name">.</span>
├── main.go
└── templates
    ├── subTemplate
    │   └── subTemp1.tmpl
    └── temp1.tmpl
</code></pre></div><ul><li><p>LoadHTMLGlob</p> <ul><li><p><code>router.LoadHTMLGlob(&quot;templates/*&quot;)</code></p> <p>报错：<code>panic: read templates/subTemplate: is a directory</code></p> <p><code>*</code>只能对应文件，而不是文件夹。</p></li> <li><p><code>router.LoadHTMLGlob(&quot;templates/**/*&quot;)</code></p> <p>报错：<code>html/template: &quot;temp1.tmpl&quot; is undefined</code></p> <p><code>**</code>匹配的文件夹，导致<code>tmpl</code>文件无法匹配。</p></li></ul> <p>综上，使用<code>LoadHTMLGlob</code>时必须严格遵守通配符<code>*/**</code>的规则。</p></li> <li><p>LoadHTMLFiles</p> <ul><li><p><code>router.LoadHTMLFiles(&quot;templates/temp1.tmpl&quot;, &quot;templates/subTemplate/subTemp1.tmpl&quot;)</code></p> <p>能够正常加载所有tmpl，缺点就是书写过于复杂。</p></li></ul></li></ul> <p><code>LoadHTMLGlob</code>和<code>LoadHTMLFiles</code>在代码中多次使用时，以最后一次为准。</p> <hr> <p>使用不同目录下名称相同的模板：</p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token builtin class-name">.</span>
├── main.go
└── templates
    ├── subTemp1
    │   └── index.tmpl
    └── subTemp2
        └── index.tmpl
</code></pre></div><ul><li><p>subTemp1</p> <div class="language-html extra-class"><pre class="language-html"><code>{{ define &quot;subTemp1/index.tmpl&quot; }}
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>html</span> <span class="token attr-name">lang</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>en<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">&gt;</span></span>
        subTemp1/index.tmpl 为 context.HTML 方法传入的 name 参数。
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>html</span><span class="token punctuation">&gt;</span></span>
{{ end }}

</code></pre></div></li> <li><p>subTemp2</p> <div class="language-html extra-class"><pre class="language-html"><code>{{ define &quot;subTemp1/index.tmpl&quot; }}
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>html</span> <span class="token attr-name">lang</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>en<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">&gt;</span></span>
        subTemp2/index.tmpl 为 context.HTML 方法传入的 name 参数。
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>html</span><span class="token punctuation">&gt;</span></span>
{{ end }}
</code></pre></div></li></ul> <hr> <p>自定义分隔符：</p> <div class="language-go extra-class"><pre class="language-go"><code>router<span class="token punctuation">.</span><span class="token function">Delims</span><span class="token punctuation">(</span><span class="token string">&quot;{[{&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;}]}&quot;</span><span class="token punctuation">)</span>		<span class="token comment">// 默认 {{ }}</span>
</code></pre></div><hr> <p>过滤器：模板内可直接引用渲染脚本里面的方法。</p> <h3 id="jsonp"><a href="#jsonp" class="header-anchor">#</a> JSONP</h3> <p>使用 <a href="https://www.runoob.com/json/json-jsonp.html" target="_blank" rel="noopener noreferrer">JSONP<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 向不同域的服务器请求数据。如果查询参数存在回调，则将回调添加到响应体中。</p> <div class="language-go extra-class"><pre class="language-go"><code>router<span class="token punctuation">.</span><span class="token function">GET</span><span class="token punctuation">(</span><span class="token string">&quot;/JSONP&quot;</span><span class="token punctuation">,</span> <span class="token keyword">func</span><span class="token punctuation">(</span>context <span class="token operator">*</span>gin<span class="token punctuation">.</span>Context<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    data <span class="token operator">:=</span> <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">{</span>
        <span class="token string">&quot;foo&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;bar&quot;</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span>
    context<span class="token punctuation">.</span><span class="token function">JSONP</span><span class="token punctuation">(</span>http<span class="token punctuation">.</span>StatusOK<span class="token punctuation">,</span> data<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token comment">// http://0.0.0.0:8080/JSONP 					{&quot;foo&quot;:&quot;bar&quot;}</span>
<span class="token comment">// http://0.0.0.0:8080/JSONP?callback=func		func({&quot;foo&quot;:&quot;bar&quot;});</span>
</code></pre></div><h3 id="purejson"><a href="#purejson" class="header-anchor">#</a> PureJSON</h3> <p>Go 1.6 +</p> <p>简单对比：</p> <ul><li><p><code>c.JSON(200, gin.H{&quot;html&quot;: &quot;&lt;b&gt;Hello, world!&lt;/b&gt;&quot;,})</code></p> <p>resp: <code>{&quot;html&quot;:&quot;\u003cb\u003eHello, world!\u003c/b\u003e&quot;}</code></p></li> <li><p><code>c.PureJSON(200, gin.H{&quot;html&quot;: &quot;&lt;b&gt;Hello, world!&lt;/b&gt;&quot;,})</code></p> <p>resp: <code>{&quot;html&quot;:&quot;&lt;b&gt;Hello, world!&lt;/b&gt;&quot;}</code></p></li></ul> <h3 id="securejson"><a href="#securejson" class="header-anchor">#</a> ？SecureJSON</h3> <p>防止json劫持。不懂。</p> <h3 id="表单和查询参数"><a href="#表单和查询参数" class="header-anchor">#</a> 表单和查询参数</h3> <ul><li><p>表单验证：</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">type</span> LoginForm <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	User     <span class="token builtin">string</span> <span class="token string">`form:&quot;user&quot; binding:&quot;required&quot;`</span>
	Password <span class="token builtin">string</span> <span class="token string">`form:&quot;password&quot; binding:&quot;required&quot;`</span>
<span class="token punctuation">}</span>

<span class="token comment">/*
...
*/</span>
router<span class="token punctuation">.</span><span class="token function">POST</span><span class="token punctuation">(</span><span class="token string">&quot;/login&quot;</span><span class="token punctuation">,</span> <span class="token keyword">func</span><span class="token punctuation">(</span>context <span class="token operator">*</span>gin<span class="token punctuation">.</span>Context<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> form LoginForm
    <span class="token keyword">if</span> context<span class="token punctuation">.</span><span class="token function">ShouldBind</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>form<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> form<span class="token punctuation">.</span>User <span class="token operator">==</span> <span class="token string">&quot;jay&quot;</span> <span class="token operator">&amp;&amp;</span> form<span class="token punctuation">.</span>Password <span class="token operator">==</span> <span class="token string">&quot;chou&quot;</span> <span class="token punctuation">{</span>
            context<span class="token punctuation">.</span><span class="token function">JSON</span><span class="token punctuation">(</span>http<span class="token punctuation">.</span>StatusOK<span class="token punctuation">,</span> gin<span class="token punctuation">.</span>H<span class="token punctuation">{</span><span class="token string">&quot;status&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;success!&quot;</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    context<span class="token punctuation">.</span><span class="token function">JSON</span><span class="token punctuation">(</span>http<span class="token punctuation">.</span>StatusUnauthorized<span class="token punctuation">,</span> gin<span class="token punctuation">.</span>H<span class="token punctuation">{</span><span class="token string">&quot;status&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;unauthorized&quot;</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token comment">// ShouldBind -&gt; binding.Default 将自动选择合适的绑定</span>
</code></pre></div></li> <li><p>自定义表单验证</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">var</span> myValidator validator<span class="token punctuation">.</span>Func <span class="token operator">=</span> <span class="token keyword">func</span><span class="token punctuation">(</span>fl validator<span class="token punctuation">.</span>FieldLevel<span class="token punctuation">)</span> <span class="token builtin">bool</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

<span class="token keyword">type</span> myForm <span class="token keyword">struct</span> <span class="token punctuation">{</span>
    Text	<span class="token builtin">string</span> <span class="token string">`form:&quot;text&quot; binding:&quot;required,myValidator&quot;`</span>
<span class="token punctuation">}</span>
</code></pre></div></li> <li><p>默认值：</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token comment">// 查询参数</span>
id <span class="token operator">:=</span> context<span class="token punctuation">.</span><span class="token function">Query</span><span class="token punctuation">(</span><span class="token string">&quot;id&quot;</span><span class="token punctuation">)</span>
page <span class="token operator">:=</span> context<span class="token punctuation">.</span><span class="token function">DefaultQuery</span><span class="token punctuation">(</span><span class="token string">&quot;page&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;0&quot;</span><span class="token punctuation">)</span>
<span class="token comment">// 表单</span>
message <span class="token operator">:=</span> context<span class="token punctuation">.</span><span class="token function">PostForm</span><span class="token punctuation">(</span><span class="token string">&quot;message&quot;</span><span class="token punctuation">)</span>
nick <span class="token operator">:=</span> context<span class="token punctuation">.</span><span class="token function">DefaultPostForm</span><span class="token punctuation">(</span><span class="token string">&quot;nick&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;anonymous&quot;</span><span class="token punctuation">)</span>
</code></pre></div></li></ul> <h3 id="将request-body绑定到不同的结构体"><a href="#将request-body绑定到不同的结构体" class="header-anchor">#</a> ？将<code>request body</code>绑定到不同的结构体</h3> <p>后续跟随实战学习。</p> <p><a href="https://gin-gonic.com/zh-cn/docs/examples/binding-and-validation/" target="_blank" rel="noopener noreferrer">模型绑定和验证<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p><a href="https://gin-gonic.com/zh-cn/docs/examples/bind-html-checkbox/" target="_blank" rel="noopener noreferrer">绑定 HTML 复选框<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <ul><li><p>绑定URI</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">type</span> Person <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	ID   <span class="token builtin">string</span> <span class="token string">`uri:&quot;id&quot; binding:&quot;required,uuid&quot;`</span>
	Name <span class="token builtin">string</span> <span class="token string">`uri:&quot;name&quot; binding:&quot;required&quot;`</span>
<span class="token punctuation">}</span>

<span class="token comment">// curl -v localhost:8088/thinkerou/987fbc97-4bed-5078-9f07-9141ba07c9f3</span>
router<span class="token punctuation">.</span><span class="token function">GET</span><span class="token punctuation">(</span><span class="token string">&quot;/:name/:id&quot;</span><span class="token punctuation">,</span> <span class="token keyword">func</span><span class="token punctuation">(</span>c <span class="token operator">*</span>gin<span class="token punctuation">.</span>Context<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> person Person
    <span class="token keyword">if</span> err <span class="token operator">:=</span> c<span class="token punctuation">.</span><span class="token function">ShouldBindUri</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>person<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
        c<span class="token punctuation">.</span><span class="token function">JSON</span><span class="token punctuation">(</span><span class="token number">400</span><span class="token punctuation">,</span> gin<span class="token punctuation">.</span>H<span class="token punctuation">{</span><span class="token string">&quot;msg&quot;</span><span class="token punctuation">:</span> err<span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span>
    <span class="token punctuation">}</span>
    c<span class="token punctuation">.</span><span class="token function">JSON</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">,</span> gin<span class="token punctuation">.</span>H<span class="token punctuation">{</span><span class="token string">&quot;name&quot;</span><span class="token punctuation">:</span> person<span class="token punctuation">.</span>Name<span class="token punctuation">,</span> <span class="token string">&quot;uuid&quot;</span><span class="token punctuation">:</span> person<span class="token punctuation">.</span>ID<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div></li></ul> <h3 id="文件上传"><a href="#文件上传" class="header-anchor">#</a> 文件上传</h3> <ul><li><p>文件大小限制：<code>router.MaxMultipartMemory = 8 &lt;&lt; 20 // 8 MiB 默认 32 MiB</code></p></li> <li><p>单文件：<code>file, err := c.FormFile(&quot;file&quot;)</code></p></li> <li><p>多文件：</p> <div class="language-go extra-class"><pre class="language-go"><code>form<span class="token punctuation">,</span> <span class="token boolean">_</span> <span class="token operator">:=</span> c<span class="token punctuation">.</span><span class="token function">MultipartForm</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
files <span class="token operator">:=</span> form<span class="token punctuation">.</span>File<span class="token punctuation">[</span><span class="token string">&quot;fileKey&quot;</span><span class="token punctuation">]</span>  <span class="token comment">// {[]*mime/multipart.FileHeader}</span>
</code></pre></div></li> <li><p>文件保存：<code>c.SaveUploadedFile(file, dst)</code></p></li></ul> <p>实际测试下来文件大小限制并未生效，大于8MiB的文件依然能够正常上传保存。</p> <p><img src="/images/go/GinWeb-1/fileSize.jpg" alt="chromedriver"></p> <h3 id="从-reader-读取数据-文件下载"><a href="#从-reader-读取数据-文件下载" class="header-anchor">#</a> 从 reader 读取数据（文件下载）</h3> <p>存在的意义只能想到文件下载。</p> <div class="language-go extra-class"><pre class="language-go"><code>router<span class="token punctuation">.</span><span class="token function">GET</span><span class="token punctuation">(</span><span class="token string">&quot;/someDataFromReader&quot;</span><span class="token punctuation">,</span> <span class="token keyword">func</span><span class="token punctuation">(</span>c <span class="token operator">*</span>gin<span class="token punctuation">.</span>Context<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    response<span class="token punctuation">,</span> err <span class="token operator">:=</span> http<span class="token punctuation">.</span><span class="token function">Get</span><span class="token punctuation">(</span><span class="token string">&quot;https://avatars.githubusercontent.com/u/42144949&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token operator">||</span> response<span class="token punctuation">.</span>StatusCode <span class="token operator">!=</span> http<span class="token punctuation">.</span>StatusOK <span class="token punctuation">{</span>
        c<span class="token punctuation">.</span><span class="token function">Status</span><span class="token punctuation">(</span>http<span class="token punctuation">.</span>StatusServiceUnavailable<span class="token punctuation">)</span>
        <span class="token keyword">return</span>
    <span class="token punctuation">}</span>

    reader <span class="token operator">:=</span> response<span class="token punctuation">.</span>Body
    contentLength <span class="token operator">:=</span> response<span class="token punctuation">.</span>ContentLength
    contentType <span class="token operator">:=</span> response<span class="token punctuation">.</span>Header<span class="token punctuation">.</span><span class="token function">Get</span><span class="token punctuation">(</span><span class="token string">&quot;Content-Type&quot;</span><span class="token punctuation">)</span>

    extraHeaders <span class="token operator">:=</span> <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">{</span>
        <span class="token string">&quot;Content-Disposition&quot;</span><span class="token punctuation">:</span> <span class="token string">`attachment; filename=&quot;gopher.png&quot;`</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span>

    c<span class="token punctuation">.</span><span class="token function">DataFromReader</span><span class="token punctuation">(</span>http<span class="token punctuation">.</span>StatusOK<span class="token punctuation">,</span> contentLength<span class="token punctuation">,</span> contentType<span class="token punctuation">,</span> reader<span class="token punctuation">,</span> extraHeaders<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><h3 id="优雅地重启或停止"><a href="#优雅地重启或停止" class="header-anchor">#</a> 优雅地重启或停止</h3> <p><a href="https://gin-gonic.com/zh-cn/docs/examples/graceful-restart-or-stop/" target="_blank" rel="noopener noreferrer">你想优雅地重启或停止 web 服务器吗？<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p>没体会到优雅在哪，不过<code>context.WithTimeout</code>和<code>signal.Notify</code>是个好东西。</p> <h3 id="basicauth-中间件"><a href="#basicauth-中间件" class="header-anchor">#</a> BasicAuth 中间件</h3> <div class="language-go extra-class"><pre class="language-go"><code><span class="token comment">// 模拟的用户数据</span>
<span class="token keyword">var</span> secrets <span class="token operator">=</span> gin<span class="token punctuation">.</span>H<span class="token punctuation">{</span>
	<span class="token string">&quot;foo&quot;</span><span class="token punctuation">:</span>    gin<span class="token punctuation">.</span>H<span class="token punctuation">{</span><span class="token string">&quot;email&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;foo@bar.com&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;phone&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;123433&quot;</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
	<span class="token string">&quot;austin&quot;</span><span class="token punctuation">:</span> gin<span class="token punctuation">.</span>H<span class="token punctuation">{</span><span class="token string">&quot;email&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;austin@example.com&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;phone&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;666&quot;</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
	<span class="token string">&quot;lena&quot;</span><span class="token punctuation">:</span>   gin<span class="token punctuation">.</span>H<span class="token punctuation">{</span><span class="token string">&quot;email&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;lena@guapa.com&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;phone&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;523443&quot;</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>

<span class="token comment">// 路由组使用 gin.BasicAuth() 中间件</span>
<span class="token comment">// gin.Accounts 是 map[string]string 的一种快捷方式</span>
authorized <span class="token operator">:=</span> r<span class="token punctuation">.</span><span class="token function">Group</span><span class="token punctuation">(</span><span class="token string">&quot;/admin&quot;</span><span class="token punctuation">,</span> gin<span class="token punctuation">.</span><span class="token function">BasicAuth</span><span class="token punctuation">(</span>gin<span class="token punctuation">.</span>Accounts<span class="token punctuation">{</span>
    <span class="token string">&quot;foo&quot;</span><span class="token punctuation">:</span>    <span class="token string">&quot;bar&quot;</span><span class="token punctuation">,</span>		<span class="token comment">// 账号密码</span>
    <span class="token string">&quot;austin&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;1234&quot;</span><span class="token punctuation">,</span>
    <span class="token string">&quot;lena&quot;</span><span class="token punctuation">:</span>   <span class="token string">&quot;hello2&quot;</span><span class="token punctuation">,</span>
    <span class="token string">&quot;manu&quot;</span><span class="token punctuation">:</span>   <span class="token string">&quot;4321&quot;</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token comment">// /admin/secrets 端点</span>
<span class="token comment">// 触发 &quot;localhost:8080/admin/secrets</span>
authorized<span class="token punctuation">.</span><span class="token function">GET</span><span class="token punctuation">(</span><span class="token string">&quot;/secrets&quot;</span><span class="token punctuation">,</span> <span class="token keyword">func</span><span class="token punctuation">(</span>c <span class="token operator">*</span>gin<span class="token punctuation">.</span>Context<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 获取用户，它是由 BasicAuth 中间件设置的</span>
    user <span class="token operator">:=</span> c<span class="token punctuation">.</span><span class="token function">MustGet</span><span class="token punctuation">(</span>gin<span class="token punctuation">.</span>AuthUserKey<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token builtin">string</span><span class="token punctuation">)</span>  <span class="token comment">// 断言 string 类型</span>
    <span class="token keyword">if</span> secret<span class="token punctuation">,</span> ok <span class="token operator">:=</span> secrets<span class="token punctuation">[</span>user<span class="token punctuation">]</span><span class="token punctuation">;</span> ok <span class="token punctuation">{</span>
        c<span class="token punctuation">.</span><span class="token function">JSON</span><span class="token punctuation">(</span>http<span class="token punctuation">.</span>StatusOK<span class="token punctuation">,</span> gin<span class="token punctuation">.</span>H<span class="token punctuation">{</span><span class="token string">&quot;user&quot;</span><span class="token punctuation">:</span> user<span class="token punctuation">,</span> <span class="token string">&quot;secret&quot;</span><span class="token punctuation">:</span> secret<span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        c<span class="token punctuation">.</span><span class="token function">JSON</span><span class="token punctuation">(</span>http<span class="token punctuation">.</span>StatusOK<span class="token punctuation">,</span> gin<span class="token punctuation">.</span>H<span class="token punctuation">{</span><span class="token string">&quot;user&quot;</span><span class="token punctuation">:</span> user<span class="token punctuation">,</span> <span class="token string">&quot;secret&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;NO SECRET :(&quot;</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p>测试用，清空浏览器登录信息，重启即可：<code>Chrome：//restart</code></p> <h3 id="中间件"><a href="#中间件" class="header-anchor">#</a> 中间件</h3> <ul><li><p>全局中间件</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token comment">// 默认使用的 gin.Default() 已加载了两个中间件 Logger/Recovery</span>
<span class="token comment">/*
func Default() *Engine {
	debugPrintWARNINGDefault()
	engine := New()
	engine.Use(Logger(), Recovery())
	return engine
}
*/</span>
<span class="token comment">// 全局注册</span>
r <span class="token operator">:=</span> gin<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment">// 没有任何中间件的路由</span>
r<span class="token punctuation">.</span><span class="token function">Use</span><span class="token punctuation">(</span>gin<span class="token punctuation">.</span><span class="token function">Logger</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre></div></li> <li><p>路由中间件</p> <div class="language-go extra-class"><pre class="language-go"><code>r<span class="token punctuation">.</span><span class="token function">GET</span><span class="token punctuation">(</span><span class="token string">&quot;/hander&quot;</span><span class="token punctuation">,</span> <span class="token function">Hander</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">func</span><span class="token punctuation">(</span>c <span class="token operator">*</span>gin<span class="token punctuation">.</span>Context<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token comment">/* 
实际上之前写的 func 部分也可以看做是中间件，以 .GET 方法源码为例：
func (group *RouterGroup) GET(relativePath string, handlers ...HandlerFunc) IRoutes {
	return group.handle(http.MethodGet, relativePath, handlers)
}
除了路径参数外，可变参数部分类型均为 HandlerFunc 。如：
func BasicAuth(accounts Accounts) HandlerFunc {
	return BasicAuthForRealm(accounts, &quot;&quot;)
}
*/</span>
</code></pre></div></li> <li><p>路由组</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token comment">// 路由组注册</span>
authorized <span class="token operator">:=</span> r<span class="token punctuation">.</span><span class="token function">Group</span><span class="token punctuation">(</span><span class="token string">&quot;/auth&quot;</span><span class="token punctuation">)</span>
authorized<span class="token punctuation">.</span><span class="token function">Use</span><span class="token punctuation">(</span><span class="token function">AuthRequired</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    authorized<span class="token punctuation">.</span><span class="token function">POST</span><span class="token punctuation">(</span><span class="token string">&quot;/login&quot;</span><span class="token punctuation">,</span> loginEndpoint<span class="token punctuation">)</span>
    <span class="token comment">// 路由组嵌套</span>
    testing <span class="token operator">:=</span> authorized<span class="token punctuation">.</span><span class="token function">Group</span><span class="token punctuation">(</span><span class="token string">&quot;testing&quot;</span><span class="token punctuation">)</span>
    testing<span class="token punctuation">.</span><span class="token function">GET</span><span class="token punctuation">(</span><span class="token string">&quot;/analytics&quot;</span><span class="token punctuation">,</span> analyticsEndpoint<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div></li> <li><p>自定义中间件</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">Logger</span><span class="token punctuation">(</span><span class="token punctuation">)</span> gin<span class="token punctuation">.</span>HandlerFunc <span class="token punctuation">{</span>
	<span class="token keyword">return</span> <span class="token keyword">func</span><span class="token punctuation">(</span>c <span class="token operator">*</span>gin<span class="token punctuation">.</span>Context<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		t <span class="token operator">:=</span> time<span class="token punctuation">.</span><span class="token function">Now</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		<span class="token comment">// 设置 example 变量</span>
		c<span class="token punctuation">.</span><span class="token function">Set</span><span class="token punctuation">(</span><span class="token string">&quot;example&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;12345&quot;</span><span class="token punctuation">)</span>
		<span class="token comment">// 请求前</span>
		c<span class="token punctuation">.</span><span class="token function">Next</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		<span class="token comment">// 请求后</span>
		latency <span class="token operator">:=</span> time<span class="token punctuation">.</span><span class="token function">Since</span><span class="token punctuation">(</span>t<span class="token punctuation">)</span>
		log<span class="token punctuation">.</span><span class="token function">Print</span><span class="token punctuation">(</span>latency<span class="token punctuation">)</span>
		<span class="token comment">// 获取发送的 status</span>
		status <span class="token operator">:=</span> c<span class="token punctuation">.</span>Writer<span class="token punctuation">.</span><span class="token function">Status</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		log<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>status<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div></li></ul> <h3 id="中间件中使用-goroutine"><a href="#中间件中使用-goroutine" class="header-anchor">#</a> 中间件中使用 Goroutine</h3> <p>当在中间件或 handler 中启动新的 Goroutine 时，<strong>不能</strong>使用原始的上下文，必须使用只读副本。</p> <div class="language-go extra-class"><pre class="language-go"><code>r<span class="token punctuation">.</span><span class="token function">GET</span><span class="token punctuation">(</span><span class="token string">&quot;/long_async&quot;</span><span class="token punctuation">,</span> <span class="token keyword">func</span><span class="token punctuation">(</span>c <span class="token operator">*</span>gin<span class="token punctuation">.</span>Context<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 创建在 goroutine 中使用的副本</span>
    cCp <span class="token operator">:=</span> c<span class="token punctuation">.</span><span class="token function">Copy</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">go</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 用 time.Sleep() 模拟一个长任务。</span>
        time<span class="token punctuation">.</span><span class="token function">Sleep</span><span class="token punctuation">(</span><span class="token number">5</span> <span class="token operator">*</span> time<span class="token punctuation">.</span>Second<span class="token punctuation">)</span>

        <span class="token comment">// 请注意您使用的是复制的上下文 &quot;cCp&quot;，这一点很重要</span>
        log<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;Done! in path &quot;</span> <span class="token operator">+</span> cCp<span class="token punctuation">.</span>Request<span class="token punctuation">.</span>URL<span class="token punctuation">.</span>Path<span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><h3 id="日志记录"><a href="#日志记录" class="header-anchor">#</a> 日志记录</h3> <div class="language-go extra-class"><pre class="language-go"><code><span class="token comment">// 禁用控制台颜色，将日志写入文件时不需要控制台颜色。</span>
gin<span class="token punctuation">.</span><span class="token function">DisableConsoleColor</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token comment">// 强制日志颜色化</span>
<span class="token comment">// gin.ForceConsoleColor()</span>

<span class="token comment">// 记录到文件。</span>
f<span class="token punctuation">,</span> <span class="token boolean">_</span> <span class="token operator">:=</span> os<span class="token punctuation">.</span><span class="token function">Create</span><span class="token punctuation">(</span><span class="token string">&quot;./gin.log&quot;</span><span class="token punctuation">)</span>
gin<span class="token punctuation">.</span>DefaultWriter <span class="token operator">=</span> io<span class="token punctuation">.</span><span class="token function">MultiWriter</span><span class="token punctuation">(</span>f<span class="token punctuation">)</span>

<span class="token comment">// 如果需要同时将日志写入文件和控制台，请使用以下代码。</span>
<span class="token comment">// gin.DefaultWriter = io.MultiWriter(f, os.Stdout)</span>
<span class="token comment">/* 
package io
func MultiWriter(writers ...Writer) Writer
*/</span>
</code></pre></div><h3 id="映射查询字符串或表单参数"><a href="#映射查询字符串或表单参数" class="header-anchor">#</a> 映射查询字符串或表单参数</h3> <p>官方文档示例：</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token comment">/*
POST /post?ids[a]=1234&amp;ids[b]=hello HTTP/1.1
Content-Type: application/x-www-form-urlencoded

names[first]=thinkerou&amp;names[second]=tianou
*/</span>
<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	router <span class="token operator">:=</span> gin<span class="token punctuation">.</span><span class="token function">Default</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

	router<span class="token punctuation">.</span><span class="token function">POST</span><span class="token punctuation">(</span><span class="token string">&quot;/post&quot;</span><span class="token punctuation">,</span> <span class="token keyword">func</span><span class="token punctuation">(</span>c <span class="token operator">*</span>gin<span class="token punctuation">.</span>Context<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		ids <span class="token operator">:=</span> c<span class="token punctuation">.</span><span class="token function">QueryMap</span><span class="token punctuation">(</span><span class="token string">&quot;ids&quot;</span><span class="token punctuation">)</span>
		names <span class="token operator">:=</span> c<span class="token punctuation">.</span><span class="token function">PostFormMap</span><span class="token punctuation">(</span><span class="token string">&quot;names&quot;</span><span class="token punctuation">)</span>

		fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;ids: %v; names: %v&quot;</span><span class="token punctuation">,</span> ids<span class="token punctuation">,</span> names<span class="token punctuation">)</span>
	<span class="token punctuation">}</span><span class="token punctuation">)</span>
	router<span class="token punctuation">.</span><span class="token function">Run</span><span class="token punctuation">(</span><span class="token string">&quot;:8080&quot;</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token comment">// ids: map[b:hello a:1234], names: map[second:tianou first:thinkerou]</span>
</code></pre></div><p>生活中还没碰见过这类用法，感觉更常用的应该是<code>Array</code>方法：</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token comment">/*
POST /post?ids=1234&amp;ids=hello HTTP/1.1
Content-Type: application/x-www-form-urlencoded
*/</span>
ids <span class="token operator">:=</span> c<span class="token punctuation">.</span><span class="token function">QueryArray</span><span class="token punctuation">(</span><span class="token string">&quot;ids&quot;</span><span class="token punctuation">)</span>		<span class="token comment">// Form: PostFormArray</span>
fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;ids: %v\n&quot;</span><span class="token punctuation">,</span> ids<span class="token punctuation">)</span>	<span class="token comment">// ids: [1234 hello]</span>
</code></pre></div><h3 id="自定义-http-配置"><a href="#自定义-http-配置" class="header-anchor">#</a> 自定义 HTTP 配置</h3> <p>最终都指向<code>http.Server</code>，具体参数看源码。</p> <h3 id="cookie"><a href="#cookie" class="header-anchor">#</a> Cookie</h3> <div class="language-go extra-class"><pre class="language-go"><code><span class="token comment">// get</span>
cookie<span class="token punctuation">,</span> err <span class="token operator">:=</span> c<span class="token punctuation">.</span><span class="token function">Cookie</span><span class="token punctuation">(</span><span class="token string">&quot;gin_cookie&quot;</span><span class="token punctuation">)</span>
<span class="token comment">/* set
SetCookie(name, value string, maxAge int, path, domain string, secure, httpOnly bool)
*/</span> 
c<span class="token punctuation">.</span><span class="token function">SetCookie</span><span class="token punctuation">(</span><span class="token string">&quot;gin_cookie&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;test&quot;</span><span class="token punctuation">,</span> <span class="token number">3600</span><span class="token punctuation">,</span> <span class="token string">&quot;/&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;localhost&quot;</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span>
</code></pre></div><h3 id="路由参数"><a href="#路由参数" class="header-anchor">#</a> 路由参数</h3> <p>除了利用结构体绑定方式获取值以外，常规使用方法：</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token comment">// 此 handler 将匹配 /user/john 但不会匹配 /user/ 或者 /user</span>
router<span class="token punctuation">.</span><span class="token function">GET</span><span class="token punctuation">(</span><span class="token string">&quot;/user/:name&quot;</span><span class="token punctuation">,</span> <span class="token keyword">func</span><span class="token punctuation">(</span>c <span class="token operator">*</span>gin<span class="token punctuation">.</span>Context<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    name <span class="token operator">:=</span> c<span class="token punctuation">.</span><span class="token function">Param</span><span class="token punctuation">(</span><span class="token string">&quot;name&quot;</span><span class="token punctuation">)</span>
    c<span class="token punctuation">.</span><span class="token function">String</span><span class="token punctuation">(</span>http<span class="token punctuation">.</span>StatusOK<span class="token punctuation">,</span> <span class="token string">&quot;Hello %s&quot;</span><span class="token punctuation">,</span> name<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token comment">// 此 handler 将匹配 /user/john/ 和 /user/john/send</span>
<span class="token comment">// 如果没有其他路由匹配 /user/john，它将重定向到 /user/john/</span>
router<span class="token punctuation">.</span><span class="token function">GET</span><span class="token punctuation">(</span><span class="token string">&quot;/user/:name/*action&quot;</span><span class="token punctuation">,</span> <span class="token keyword">func</span><span class="token punctuation">(</span>c <span class="token operator">*</span>gin<span class="token punctuation">.</span>Context<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    name <span class="token operator">:=</span> c<span class="token punctuation">.</span><span class="token function">Param</span><span class="token punctuation">(</span><span class="token string">&quot;name&quot;</span><span class="token punctuation">)</span>
    action <span class="token operator">:=</span> c<span class="token punctuation">.</span><span class="token function">Param</span><span class="token punctuation">(</span><span class="token string">&quot;action&quot;</span><span class="token punctuation">)</span>
    message <span class="token operator">:=</span> name <span class="token operator">+</span> <span class="token string">&quot; is &quot;</span> <span class="token operator">+</span> action
    c<span class="token punctuation">.</span><span class="token function">String</span><span class="token punctuation">(</span>http<span class="token punctuation">.</span>StatusOK<span class="token punctuation">,</span> message<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><h3 id="重定向"><a href="#重定向" class="header-anchor">#</a> 重定向</h3> <p>常规：</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token comment">// Redirect returns a HTTP redirect to the specific location.</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>c <span class="token operator">*</span>Context<span class="token punctuation">)</span> <span class="token function">Redirect</span><span class="token punctuation">(</span>code <span class="token builtin">int</span><span class="token punctuation">,</span> location <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	c<span class="token punctuation">.</span><span class="token function">Render</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> render<span class="token punctuation">.</span>Redirect<span class="token punctuation">{</span>
		Code<span class="token punctuation">:</span>     code<span class="token punctuation">,</span>
		Location<span class="token punctuation">:</span> location<span class="token punctuation">,</span>
		Request<span class="token punctuation">:</span>  c<span class="token punctuation">.</span>Request<span class="token punctuation">,</span>
	<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p>路由重定向：</p> <div class="language-go extra-class"><pre class="language-go"><code>r<span class="token punctuation">.</span><span class="token function">GET</span><span class="token punctuation">(</span><span class="token string">&quot;/test&quot;</span><span class="token punctuation">,</span> <span class="token keyword">func</span><span class="token punctuation">(</span>c <span class="token operator">*</span>gin<span class="token punctuation">.</span>Context<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    c<span class="token punctuation">.</span>Request<span class="token punctuation">.</span>URL<span class="token punctuation">.</span>Path <span class="token operator">=</span> <span class="token string">&quot;/test2&quot;</span>
    r<span class="token punctuation">.</span><span class="token function">HandleContext</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><h3 id="静态文件服务"><a href="#静态文件服务" class="header-anchor">#</a> 静态文件服务</h3> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	router <span class="token operator">:=</span> gin<span class="token punctuation">.</span><span class="token function">Default</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token comment">// 内里不够深厚，看不出来 Static 和 StaticFS 方法的区别</span>
	router<span class="token punctuation">.</span><span class="token function">Static</span><span class="token punctuation">(</span><span class="token string">&quot;/assets&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;./assets&quot;</span><span class="token punctuation">)</span>
	router<span class="token punctuation">.</span><span class="token function">StaticFS</span><span class="token punctuation">(</span><span class="token string">&quot;/more_static&quot;</span><span class="token punctuation">,</span> http<span class="token punctuation">.</span><span class="token function">Dir</span><span class="token punctuation">(</span><span class="token string">&quot;my_file_system&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token comment">// 单文件用 StaticFile</span>
	router<span class="token punctuation">.</span><span class="token function">StaticFile</span><span class="token punctuation">(</span><span class="token string">&quot;/favicon.ico&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;./resources/favicon.ico&quot;</span><span class="token punctuation">)</span>

	<span class="token comment">// 监听并在 0.0.0.0:8080 上启动服务</span>
	router<span class="token punctuation">.</span><span class="token function">Run</span><span class="token punctuation">(</span><span class="token string">&quot;:8080&quot;</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">上一次编辑于:</span> <span class="time">3/18/2021, 10:32:16 AM</span></div></footer> <!----> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.c5305ee3.js" defer></script><script src="/assets/js/2.2733607c.js" defer></script><script src="/assets/js/8.4f988748.js" defer></script>
  </body>
</html>
