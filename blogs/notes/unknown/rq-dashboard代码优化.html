<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>起因 | Jayzau</title>
    <meta name="generator" content="VuePress 1.7.1">
    
    <meta name="description" content="好劲!">
    
    <link rel="preload" href="/assets/css/0.styles.c0542458.css" as="style"><link rel="preload" href="/assets/js/app.c5305ee3.js" as="script"><link rel="preload" href="/assets/js/2.2733607c.js" as="script"><link rel="preload" href="/assets/js/24.dfaf9b90.js" as="script"><link rel="prefetch" href="/assets/js/10.ef8e919d.js"><link rel="prefetch" href="/assets/js/11.8ec9eea4.js"><link rel="prefetch" href="/assets/js/12.d902eacd.js"><link rel="prefetch" href="/assets/js/13.aec05fab.js"><link rel="prefetch" href="/assets/js/14.2805f5ea.js"><link rel="prefetch" href="/assets/js/15.8a264712.js"><link rel="prefetch" href="/assets/js/16.3b4138e0.js"><link rel="prefetch" href="/assets/js/17.eec3c406.js"><link rel="prefetch" href="/assets/js/18.25d28f03.js"><link rel="prefetch" href="/assets/js/19.090949aa.js"><link rel="prefetch" href="/assets/js/20.43c0a74c.js"><link rel="prefetch" href="/assets/js/21.f60ea17e.js"><link rel="prefetch" href="/assets/js/22.022efc2e.js"><link rel="prefetch" href="/assets/js/23.a3cee758.js"><link rel="prefetch" href="/assets/js/25.4bb80798.js"><link rel="prefetch" href="/assets/js/26.7dc791f1.js"><link rel="prefetch" href="/assets/js/27.b87628ec.js"><link rel="prefetch" href="/assets/js/28.b44871cc.js"><link rel="prefetch" href="/assets/js/29.ac371324.js"><link rel="prefetch" href="/assets/js/3.2241a300.js"><link rel="prefetch" href="/assets/js/30.c10170f6.js"><link rel="prefetch" href="/assets/js/31.ab3d6217.js"><link rel="prefetch" href="/assets/js/32.1e3fbc5c.js"><link rel="prefetch" href="/assets/js/33.13439f83.js"><link rel="prefetch" href="/assets/js/34.ee9bff09.js"><link rel="prefetch" href="/assets/js/35.b9fbcc7f.js"><link rel="prefetch" href="/assets/js/36.9293bf0b.js"><link rel="prefetch" href="/assets/js/37.71f16844.js"><link rel="prefetch" href="/assets/js/38.2c1388e6.js"><link rel="prefetch" href="/assets/js/4.5a3a6bf8.js"><link rel="prefetch" href="/assets/js/5.aad4954c.js"><link rel="prefetch" href="/assets/js/6.20be021d.js"><link rel="prefetch" href="/assets/js/7.5a1615ac.js"><link rel="prefetch" href="/assets/js/8.4f988748.js"><link rel="prefetch" href="/assets/js/9.e5f1a567.js">
    <link rel="stylesheet" href="/assets/css/0.styles.c0542458.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">Jayzau</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">
  首页
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="博客" class="dropdown-title"><span class="title">博客</span> <span class="arrow down"></span></button> <button type="button" aria-label="博客" class="mobile-dropdown-title"><span class="title">博客</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/blogs/notes/" class="nav-link router-link-active">
  笔记
</a></li><li class="dropdown-item"><!----> <a href="/blogs/python/" class="nav-link">
  Python
</a></li><li class="dropdown-item"><!----> <a href="/blogs/javascript/" class="nav-link">
  JavaScript
</a></li><li class="dropdown-item"><!----> <a href="/blogs/php/" class="nav-link">
  PHP
</a></li><li class="dropdown-item"><!----> <a href="/blogs/go/" class="nav-link">
  Go
</a></li></ul></div></div><div class="nav-item"><a href="https://github.com/jayzau" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">
  首页
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="博客" class="dropdown-title"><span class="title">博客</span> <span class="arrow down"></span></button> <button type="button" aria-label="博客" class="mobile-dropdown-title"><span class="title">博客</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/blogs/notes/" class="nav-link router-link-active">
  笔记
</a></li><li class="dropdown-item"><!----> <a href="/blogs/python/" class="nav-link">
  Python
</a></li><li class="dropdown-item"><!----> <a href="/blogs/javascript/" class="nav-link">
  JavaScript
</a></li><li class="dropdown-item"><!----> <a href="/blogs/php/" class="nav-link">
  PHP
</a></li><li class="dropdown-item"><!----> <a href="/blogs/go/" class="nav-link">
  Go
</a></li></ul></div></div><div class="nav-item"><a href="https://github.com/jayzau" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>起因</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/blogs/notes/unknown/rq-dashboard%E4%BB%A3%E7%A0%81%E4%BC%98%E5%8C%96.html#起因" class="sidebar-link">起因</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/blogs/notes/unknown/rq-dashboard%E4%BB%A3%E7%A0%81%E4%BC%98%E5%8C%96.html#舒服了" class="sidebar-link">舒服了</a><ul class="sidebar-sub-headers"></ul></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h2 id="起因"><a href="#起因" class="header-anchor">#</a> 起因</h2> <p>在使用<code>rq</code>队列处理异步任务的时候，总会希望有一个地方能够实时看见任务进度，执行结果。</p> <p><a href="https://pypi.org/project/rq-dashboard/" target="_blank" rel="noopener noreferrer">rq-dashboard<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>很好的实现了这个功能，而且上手简单，功能齐全，界面美观。</p> <p>不过在使用过程中遇见一个问题，如下图。</p> <p><img src="/images/notes/rq-dashboard%E4%BB%A3%E7%A0%81%E4%BC%98%E5%8C%96/screenshot.png" alt=""></p> <p>可以看见，<code>rq-dashboard</code>非常贴心的提供了失败任务专栏。报错的任务全都会在这下面展现，报错详情，任务id，应有尽有，右上侧还提供了<code>Requeue All</code>方法，可以让失败的任务一键归队重新执行。</p> <p>不过由于一些未知的原因，我的部分任务在执行过程中丢失了信息，队列里红色的<code>failed job</code>异常显眼，但详情栏里并没有找到对应的<code>job</code>。出现这种情况的时候一键归队也失效，响应码500，看来是后端代码出了问题。</p> <p><code>rq-dashboard</code>使用的是<code>flask</code>框架，轻量级，代码比较直观，调试中不难发现<code>Requeue All</code>方法是遍历所有失败任务，通过任务id一个一个一次归队，那么只要其中任何一个任务获取失败（NoSuchJobError），就会导致后续代码不能正常进行。</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token comment"># rq-dashboard 视图层函数</span>

<span class="token decorator annotation punctuation">@blueprint<span class="token punctuation">.</span>route</span><span class="token punctuation">(</span><span class="token string">'/requeue-all'</span><span class="token punctuation">,</span> methods<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">'GET'</span><span class="token punctuation">,</span> <span class="token string">'POST'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token decorator annotation punctuation">@jsonify</span>
<span class="token keyword">def</span> <span class="token function">requeue_all</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    fq <span class="token operator">=</span> get_failed_queue<span class="token punctuation">(</span><span class="token punctuation">)</span>
    job_ids <span class="token operator">=</span> fq<span class="token punctuation">.</span>job_ids
    count <span class="token operator">=</span> <span class="token builtin">len</span><span class="token punctuation">(</span>job_ids<span class="token punctuation">)</span>
    <span class="token keyword">for</span> job_id <span class="token keyword">in</span> job_ids<span class="token punctuation">:</span>      <span class="token comment"># 遍历失败队列 获取任务id</span>
        requeue_job<span class="token punctuation">(</span>job_id<span class="token punctuation">,</span> connection<span class="token operator">=</span>current_app<span class="token punctuation">.</span>redis_conn<span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token builtin">dict</span><span class="token punctuation">(</span>status<span class="token operator">=</span><span class="token string">'OK'</span><span class="token punctuation">,</span> count<span class="token operator">=</span>count<span class="token punctuation">)</span>

</code></pre></div><div class="language-python extra-class"><pre class="language-python"><code><span class="token comment"># rq  job.py  453行</span>

    <span class="token comment"># Persistence</span>
    <span class="token keyword">def</span> <span class="token function">refresh</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>  <span class="token comment"># noqa</span>
        <span class="token triple-quoted-string string">&quot;&quot;&quot;Overwrite the current instance's properties with the values in the
        corresponding Redis key.

        Will raise a NoSuchJobError if no corresponding Redis key exists.
        &quot;&quot;&quot;</span>
        data <span class="token operator">=</span> self<span class="token punctuation">.</span>connection<span class="token punctuation">.</span>hgetall<span class="token punctuation">(</span>self<span class="token punctuation">.</span>key<span class="token punctuation">)</span>
        <span class="token keyword">if</span> <span class="token keyword">not</span> data<span class="token punctuation">:</span>
            <span class="token keyword">raise</span> NoSuchJobError<span class="token punctuation">(</span><span class="token string">'No such job: {0}'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>key<span class="token punctuation">)</span><span class="token punctuation">)</span>       <span class="token comment"># 任务获取失败</span>
        self<span class="token punctuation">.</span>restore<span class="token punctuation">(</span>data<span class="token punctuation">)</span>
</code></pre></div><p>找到了原因，就容易解决了。</p> <p>只需要捕捉到异常任务，然后再删除相应数据就行了，正常任务按原方法处理。</p> <p>三方包代码不建议直接修改，所以新建了个入口文件，再替换相关方法。代码如下：</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token triple-quoted-string string">&quot;&quot;&quot;
RQ-dashboard version: 0.6.1
Python RQ version: 1.1.0
&quot;&quot;&quot;</span>
<span class="token keyword">import</span> importlib
<span class="token keyword">import</span> os

<span class="token keyword">from</span> rq <span class="token keyword">import</span> requeue_job<span class="token punctuation">,</span> Queue
<span class="token keyword">from</span> rq<span class="token punctuation">.</span>exceptions <span class="token keyword">import</span> NoSuchJobError
<span class="token keyword">from</span> rq<span class="token punctuation">.</span>job <span class="token keyword">import</span> Job
<span class="token keyword">from</span> rq<span class="token punctuation">.</span>registry <span class="token keyword">import</span> FailedJobRegistry
<span class="token keyword">from</span> rq_dashboard <span class="token keyword">import</span> cli
<span class="token keyword">from</span> rq_dashboard<span class="token punctuation">.</span>web <span class="token keyword">import</span> jsonify<span class="token punctuation">,</span> current_app
<span class="token keyword">from</span> rq_dashboard<span class="token punctuation">.</span>compat <span class="token keyword">import</span> get_failed_queue


<span class="token decorator annotation punctuation">@cli<span class="token punctuation">.</span>blueprint<span class="token punctuation">.</span>route</span><span class="token punctuation">(</span><span class="token string">'/requeue-all'</span><span class="token punctuation">,</span> methods<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">'GET'</span><span class="token punctuation">,</span> <span class="token string">'POST'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token decorator annotation punctuation">@jsonify</span>
<span class="token keyword">def</span> <span class="token function">own_requeue_all</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    fq <span class="token operator">=</span> get_failed_queue<span class="token punctuation">(</span><span class="token punctuation">)</span>
    job_ids <span class="token operator">=</span> fq<span class="token punctuation">.</span>job_ids
    count <span class="token operator">=</span> <span class="token builtin">len</span><span class="token punctuation">(</span>job_ids<span class="token punctuation">)</span>
    reg_job_ids <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token keyword">for</span> job_id <span class="token keyword">in</span> job_ids<span class="token punctuation">:</span>
        <span class="token keyword">try</span><span class="token punctuation">:</span>
            requeue_job<span class="token punctuation">(</span>job_id<span class="token punctuation">,</span> connection<span class="token operator">=</span>current_app<span class="token punctuation">.</span>redis_conn<span class="token punctuation">)</span>
        <span class="token keyword">except</span> NoSuchJobError<span class="token punctuation">:</span>      <span class="token comment"># 异常捕捉</span>
            job <span class="token operator">=</span> Job<span class="token punctuation">(</span><span class="token builtin">id</span><span class="token operator">=</span>job_id<span class="token punctuation">)</span>
            job<span class="token punctuation">.</span>connection<span class="token punctuation">.</span>delete<span class="token punctuation">(</span>job<span class="token punctuation">.</span>key<span class="token punctuation">)</span>      <span class="token comment"># 删除相关数据</span>
            reg_job_ids<span class="token punctuation">.</span>append<span class="token punctuation">(</span>job_id<span class="token punctuation">)</span>
    <span class="token keyword">if</span> reg_job_ids<span class="token punctuation">:</span>     <span class="token comment"># 删除相关数据</span>
        <span class="token keyword">for</span> n <span class="token keyword">in</span> Queue<span class="token punctuation">.</span><span class="token builtin">all</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            name <span class="token operator">=</span> n<span class="token punctuation">.</span>name
            br <span class="token operator">=</span> FailedJobRegistry<span class="token punctuation">(</span>name<span class="token operator">=</span>name<span class="token punctuation">)</span>
            r <span class="token operator">=</span> br<span class="token punctuation">.</span>connection<span class="token punctuation">.</span>zrem<span class="token punctuation">(</span>br<span class="token punctuation">.</span>key<span class="token punctuation">,</span> <span class="token operator">*</span>job_ids<span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token builtin">dict</span><span class="token punctuation">(</span>status<span class="token operator">=</span><span class="token string">'OK'</span><span class="token punctuation">,</span> count<span class="token operator">=</span>count<span class="token punctuation">)</span>


<span class="token keyword">def</span> <span class="token function">make_flask_app</span><span class="token punctuation">(</span>config<span class="token punctuation">,</span> username<span class="token punctuation">,</span> password<span class="token punctuation">,</span> url_prefix<span class="token punctuation">,</span>
                   compatibility_mode<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">&quot;&quot;&quot;Return Flask app with default configuration and registered blueprint.&quot;&quot;&quot;</span>
    app <span class="token operator">=</span> cli<span class="token punctuation">.</span>Flask<span class="token punctuation">(</span>cli<span class="token punctuation">.</span>__name__<span class="token punctuation">)</span>       <span class="token comment"># 全都用原有属性</span>

    <span class="token comment"># Start configuration with our built in defaults.</span>
    app<span class="token punctuation">.</span>config<span class="token punctuation">.</span>from_object<span class="token punctuation">(</span>cli<span class="token punctuation">.</span>default_settings<span class="token punctuation">)</span>

    <span class="token comment"># Override with any settings in config file, if given.</span>
    <span class="token keyword">if</span> config<span class="token punctuation">:</span>
        app<span class="token punctuation">.</span>config<span class="token punctuation">.</span>from_object<span class="token punctuation">(</span>importlib<span class="token punctuation">.</span>import_module<span class="token punctuation">(</span>config<span class="token punctuation">)</span><span class="token punctuation">)</span>

    <span class="token comment"># Override from a configuration file in the env variable, if present.</span>
    <span class="token keyword">if</span> <span class="token string">'RQ_DASHBOARD_SETTINGS'</span> <span class="token keyword">in</span> os<span class="token punctuation">.</span>environ<span class="token punctuation">:</span>
        app<span class="token punctuation">.</span>config<span class="token punctuation">.</span>from_envvar<span class="token punctuation">(</span><span class="token string">'RQ_DASHBOARD_SETTINGS'</span><span class="token punctuation">)</span>

    <span class="token comment"># Optionally add basic auth to blueprint and register with app.</span>
    <span class="token keyword">if</span> username<span class="token punctuation">:</span>
        cli<span class="token punctuation">.</span>add_basic_auth<span class="token punctuation">(</span>cli<span class="token punctuation">.</span>blueprint<span class="token punctuation">,</span> username<span class="token punctuation">,</span> password<span class="token punctuation">)</span>
    app<span class="token punctuation">.</span>register_blueprint<span class="token punctuation">(</span>cli<span class="token punctuation">.</span>blueprint<span class="token punctuation">,</span> url_prefix<span class="token operator">=</span>url_prefix<span class="token punctuation">)</span>

    <span class="token comment"># 由于路由一样，重写的方法比原有方法后注册，所以默认会调用原有方法，这里逆个序解决</span>
    app<span class="token punctuation">.</span>url_map<span class="token punctuation">.</span>_rules<span class="token punctuation">.</span>reverse<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> app


<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>
    <span class="token comment"># 利用猴子补丁 替换原有 make_flask_app 方法</span>
    cli<span class="token punctuation">.</span>make_flask_app <span class="token operator">=</span> make_flask_app
    <span class="token comment"># 原有方法调用</span>
    cli<span class="token punctuation">.</span>main<span class="token punctuation">(</span><span class="token punctuation">)</span>

</code></pre></div><p><img src="/images/notes/rq-dashboard%E4%BB%A3%E7%A0%81%E4%BC%98%E5%8C%96/screenshot.png" alt=""></p> <h2 id="舒服了"><a href="#舒服了" class="header-anchor">#</a> 舒服了</h2> <hr> <p><a href="https://zhidao.baidu.com/question/1449368139271751780.html" target="_blank" rel="noopener noreferrer">猴子补丁的含义是指在动态语言中，不去改变源码而对功能进行追加和变更。<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">上一次编辑于:</span> <span class="time">3/10/2023, 1:41:35 PM</span></div></footer> <!----> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.c5305ee3.js" defer></script><script src="/assets/js/2.2733607c.js" defer></script><script src="/assets/js/24.dfaf9b90.js" defer></script>
  </body>
</html>
